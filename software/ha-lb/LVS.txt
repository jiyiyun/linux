LVS

NAT模式
NAT
第一步：用户访问到LVS 的外网IP ,又称为VIP
第二步，LVS将数据转发给内网真实服务器 NAT模式的转换效率比较低，每次转发前LVS会修改数据包的目标地址和目标端口，目标地址和目标端口将修改成为选出来的真实服务器的IP以及相应的端口
第三步：真实服务器返回数据包给LVS
调度器在得到内部real server的响应数据包后将源地址和源端口修改成为VIP以及调度器对应的端口，修改完成后，LVS将数据包发回终端用户。
    LVS调度器有个连接的hash表，该表记录请求以及转发信息，当同意连接的下一个数据包发送给调度器时，从该调度器hash表中查找到连接记录，并根据该记录选出相同的真实服务器以及端口信息
当后端服务器数量大于10台，NAT模式的调度器就成为瓶颈

TUN 隧道模式
   请求包远小于响应包的大小，因为响应包中含有客户需要的具体数据，所以TUN的思路就是请求和响应分离，调度器仅处理数据请求，而让真实的服务器响应数据包直接返回给客户端。
   将原始的数据包添加新的包头(源地址+端口，目标地址+端口)，从而实现将一个目标为调度器VIP地址的数据包封装，通过隧道发给后端真实服务器，通过将客户端发往调度器的原始数据包封装，并在其基础上添加新的数据包头
   TUN 模式要求后端服务器都有公网IP可以直接和外部网络连接，真实服务器收到请求包后直接给客户端主机响应数据
TUN模式可以用作异地备份，以为可以跨网，跨网段
 
DR模式
   TUN模式要求LVS调度器和真实服务器直接建立隧道连接，会增加LVS调度器负担
   DR模式也叫直接路由模式，要求调度器必须和后端真实服务器在同一局域网内，VIP地址需要和后端真实服务器地址共享，给每个真实服务器配上相同VIP地址
   真实服务器在返回给client端数据的时候，用的是VIP
   真实服务器的VIP必须设置在Non-ARP网络设备上，也就是该网络设备并不会向外广播自己的MAC地址和IP地址，真实服务器的VIP对外是不可见的，但真实服务器却可以接收目标地址为VIP的网络请求，并在回应数据包时将源地址设置为VIP地址
   调度器根据算法选出真实服务器后，在不修改报文的情况下，将数据帧的MAC地址修改成为选出的服务器的MAC地址，通过交换机将该数据帧发给真实的服务器，整个过程服务器的VIP对外不可见

LVS在内核中主要实现了八种调度算法
RR       轮询
WRR      加权轮询
LC       最小连接调度
WLC      加权最小连接
lblc     基于局部性最少连接
lblcr    带复制的基于局部性最少连接
DH       目标地址散列调度
SH       源地址散列调度

[root@centos1 ~]# yum install ipvsadm -y

ipvsadm选项
-A  添加一个虚拟服务，使用IP地址，端口号，协议来唯一定义一个虚拟服务
-E  编辑一个虚拟服务
-D  删除一个虚拟服务
-R  从标准输入中还原虚拟服务规则
-S  保存虚拟服务规则至标准输出  (因为用命令定义的规则是临时性的，长久保存需要输出至文件)
-L  显示虚拟服务列表
-a  向虚拟服务中添加一台真实服务器
-e  编辑虚拟服务中的真实服务器
-d  删除虚拟服务中的服务器
-t  使用TCP服务，参数后跟端口号
-u  使用UDP服务，参数后跟端口号
-s  指定LVS调度算法
-r  设置真实服务器的IP 地址和端口信息
-g  DR直连路由模式
-i  TUN模式
-m  NAT模式
-w  权重
-c  连接状态，需配合-L 使用
-n  数字格式输出

实例：
添加一个虚拟服务，使用轮询，TCP协议访问124.126.147.168的80端口
3台real server地址是192.168.0.11 192.168.0.12 192.168.0.13的80端口

ipvsadm -A -t 124.126.147.168:80 -s rr
ipvsadm -a -t 124.126.147.168:80 -r 192.168.0.11:80 -m
ipvsadm -a -t 124.126.147.168:80 -r 192.168.0.12:80 -m
ipvsadm -a -t 124.126.147.168:80 -r 192.168.0.13:80 -m

查看
ipvsadm -Ln
ipvsadm -Lnc

删除readl server 192.168.0.13:80
ipvsadm -d -t 124.126.147.168:80 -r 192.168.0.13

修改-E
ipvsadm -E -t 124.126.147.168:80 -s wrr

备份还原
ipvsadm -S > /tmp/ip_vs.bak
ipvsadm -C
ipvsadm -R </tmp/ip_vs.bak

创建WRR算法虚拟服务器，工作模式为直接路由模式DR,并设置权重
ipvsadm -A -t 124.126.147.169:80 -s wrr
ipvsadm -a -t 124.126.147.169:80 -r 192.168.0.11:80 -g -w 1
ipvsadm -a -t 124.126.147.169:80 -r 192.168.0.12:80 -g -w 2